<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lenstool.lenstool &mdash; Lenstool  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" type="text/css" />
  
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Lenstool
          </a>
              <div class="version">
                8.5.1

              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation of Lenstool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../method.html">Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">Tutorial</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parameter_file.html">Parameter file: Section details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../InputOutput.html">Input/Output files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Supported_pot.html">Supported Potentials</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../pywrap.html">Python wrapper</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Lenstool</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>lenstool.lenstool</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lenstool.lenstool</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">from</span> <span class="nn">ctypes</span> <span class="kn">import</span> <span class="n">POINTER</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">_lib</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">structure</span><span class="p">,</span> <span class="n">dimension</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">constant</span>
<span class="kn">import</span> <span class="nn">astropy.wcs</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<div class="viewcode-block" id="sdarray_ndarray">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.sdarray_ndarray">[docs]</a>
<span class="k">def</span> <span class="nf">sdarray_ndarray</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">nrows</span><span class="p">,</span> <span class="n">ncols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Convert Lenstool square_double array to numpy.ndarray. The memory content of the</span>
<span class="sd">        input sd_array is freed upon the call to this function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">            - array         Object of ctypes type square_double_t</span>
<span class="sd">            - nrows, ncols  Size of the first and second dimensions</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Array of type numpy.ndarray with shape (nrows, ncols)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ncols</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nrows</span><span class="p">)])</span>
    <span class="n">_lib</span><span class="o">.</span><span class="n">free_square_double</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">nrows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span></div>


<div class="viewcode-block" id="Lenstool">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool">[docs]</a>
<span class="k">class</span> <span class="nc">Lenstool</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; A lenstool instance initialized with a paramater file, and providing some high-level functions of the C version.</span>

<span class="sd">    The simplest way to initialize a Lenstool object is to load a standard</span>
<span class="sd">    lenstool parameter file</span>

<span class="sd">        &gt;&gt;&gt; lenstool = lenstool.Lenstool(&#39;test_galaxies.par&#39;)</span>

<span class="sd">    Make sure to have all the file dependencies mentioned in the parameter</span>
<span class="sd">    file available in your current directory.</span>

<span class="sd">    Note that a Lenstool instance is not thread-safe. The global variables</span>
<span class="sd">    initialized in memory by the underlying C library will be shared between</span>
<span class="sd">    multiple Lenstool instances.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    ------------</span>
<span class="sd">        - infile:     The path to the parameter file</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">infile</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_read</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelset</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_cosmoratio</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">infile</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input file </span><span class="si">{</span><span class="n">infile</span><span class="si">}</span><span class="s2"> not found in current directory&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span> <span class="o">!=</span> <span class="n">infile</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s2">&quot;Not loading input file from current directory&quot;</span><span class="p">)</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">init_grille</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="nb">bytes</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">set_default</span><span class="p">()</span>

        <span class="n">_lib</span><span class="o">.</span><span class="n">checkpar</span><span class="p">()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_NParameters</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">image</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">s_source</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">pixel</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">_lib</span><span class="o">.</span><span class="n">e_lensing</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">_lib</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">free_square_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">close_bayes</span><span class="p">()</span>

    <span class="c1">################################################################################</span>
    <span class="c1"># Retrieve global variables</span>
    <span class="c1">################################################################################</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">M</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the M global variable, with the runmode content &quot;&quot;&quot;</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_mode</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">M</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">G</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the G structure &quot;&quot;&quot;</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">G</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_grille</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">G</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">S</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the S structure &quot;&quot;&quot;</span>
        <span class="n">S</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_source</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">S</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">I</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the I structure &quot;&quot;&quot;</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_image</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">I</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">F</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the F structure &quot;&quot;&quot;</span>
        <span class="n">F</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_frame</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">F</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">CL</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the CL structure &quot;&quot;&quot;</span>
        <span class="n">CL</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">CL</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_cline</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">CL</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">C</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the C structure &quot;&quot;&quot;</span>
        <span class="n">C</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">C</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_cosmo</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">C</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">X</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the X structure associated with the X-ray&quot;&quot;&quot;</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_X_ray</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">X</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ps</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the ps structure &quot;&quot;&quot;</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">ps</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">g_pixel</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ps</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the lens array &quot;&quot;&quot;</span>
        <span class="n">t_lens</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">pot</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NLMAX</span>
        <span class="n">lens</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">lens</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_lens</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">lens</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the image array global variable &quot;&quot;&quot;</span>
        <span class="n">t_image</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">galaxie</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NIMAX</span><span class="p">)</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NFMAX</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_image</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">image</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the source array global variable &quot;&quot;&quot;</span>
        <span class="n">t_source</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">galaxie</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NFMAX</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_source</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">source</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">arclet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the arclet array global variable &quot;&quot;&quot;</span>
        <span class="n">t_arclet</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">galaxie</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NAMAX</span>
        <span class="n">arclet</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">arclet</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_arclet</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">arclet</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">narclet</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the narclet global variable &quot;&quot;&quot;</span>
        <span class="n">narclet</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">_lib</span><span class="p">,</span> <span class="s2">&quot;narclet&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">narclet</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">multi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the multi array global variable &quot;&quot;&quot;</span>
        <span class="n">t_multi</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">galaxie</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NIMAX</span><span class="p">)</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NFMAX</span>
        <span class="n">multi</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">multi</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_multi</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">multi</span>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ntline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the ntline global variable &quot;&quot;&quot;</span>
        <span class="n">ntline</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">_lib</span><span class="p">,</span> <span class="s2">&quot;ntline&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">ntline</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nrline</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the nrline global variable &quot;&quot;&quot;</span>
        <span class="n">nrline</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">_lib</span><span class="p">,</span> <span class="s2">&quot;nrline&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="k">return</span> <span class="n">nrline</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">Potfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the P structure associated with the potfile parameter&quot;&quot;&quot;</span>
        <span class="n">t_pot</span><span class="o">=</span><span class="n">structure</span><span class="o">.</span><span class="n">g_pot</span><span class="o">*</span><span class="n">dimension</span><span class="o">.</span><span class="n">NPOTFILE</span>
        <span class="n">P</span><span class="o">=</span><span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">P</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">t_pot</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">P</span>

    <span class="c1">################################################################################</span>
    <span class="c1"># Wrapper fo lenstool C functions</span>
    <span class="c1">################################################################################</span>
<div class="viewcode-block" id="Lenstool.readBayesModels">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.readBayesModels">[docs]</a>
    <span class="k">def</span> <span class="nf">readBayesModels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read the content of the bayes.dat found in the current directory &quot;&quot;&quot;</span>
        <span class="n">n_params</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n_vals</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_long</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">readBayesModels</span><span class="p">(</span><span class="n">n_params</span><span class="p">,</span> <span class="n">n_vals</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n_params</span><span class="o">.</span><span class="n">value</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># +2 because ln(Lhood0) and chi2 extra lines in bayes.dat</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model and bayes.dat number of free parameters mismatch (</span><span class="si">{0}</span><span class="s2"> != </span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">,</span> <span class="n">n_params</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nvals</span> <span class="o">=</span> <span class="n">n_vals</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="Lenstool.get_chains">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.get_chains">[docs]</a>
    <span class="k">def</span> <span class="nf">get_chains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">return_ndarray</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the content of the bayes.dat. If return_ndarray is True, the</span>
<span class="sd">            returned numpy.ndarray contains a copy of the internal memory content.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          - return_ndarray    Return a numpy.ndarray if True, otherwise return the</span>
<span class="sd">                              content in the internal ctype square_double_t type.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bayes.dat file not read. Use readBayesModels() first&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">return_ndarray</span><span class="p">:</span>
            <span class="n">np_arr</span> <span class="o">=</span> <span class="n">sdarray_ndarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">np_arr</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nvals</span></div>


<div class="viewcode-block" id="Lenstool.get_NParameters">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.get_NParameters">[docs]</a>
    <span class="k">def</span> <span class="nf">get_NParameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the number of free parameters &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_lib</span><span class="o">.</span><span class="n">getNParameters</span><span class="p">()</span></div>


<div class="viewcode-block" id="Lenstool.o_chi_lhood0">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.o_chi_lhood0">[docs]</a>
    <span class="k">def</span> <span class="nf">o_chi_lhood0</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return the chi2 and likelihood corresponding to the model and the constraints</span>
<span class="sd">        previously stored in memory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">          - error, chi, lhood0   The error value (0 is good, 1 is bad model), the chi2 and the normalization likelihood term</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chi</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">lhood0</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">np_b0</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)()</span> <span class="c1"># NULL pointer</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">o_chi_lhood0</span><span class="p">(</span><span class="n">chi</span><span class="p">,</span> <span class="n">lhood0</span><span class="p">,</span> <span class="n">np_b0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">error</span><span class="p">,</span> <span class="n">chi</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">lhood0</span><span class="o">.</span><span class="n">value</span></div>


<div class="viewcode-block" id="Lenstool.readConstraints">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.readConstraints">[docs]</a>
    <span class="k">def</span> <span class="nf">readConstraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Read in memory the constraints files (multiple images, arclets,</span>
<span class="sd">            etc.) mentioned in the input parameter file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">readConstraints</span><span class="p">()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">readConstraints_X_ray</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_read</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Lenstool.setBayesModel">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.setBayesModel">[docs]</a>
    <span class="k">def</span> <span class="nf">setBayesModel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="o">=-</span><span class="mi">4</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Select a model from the bayes.dat samples read with readBayesModels() function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        ------------</span>
<span class="sd">            - method    Specify the row from the bayes.dat from which a chires.dat file should be calculated. Special values are -4 to use the maximum likelihood row (default).</span>
<span class="sd">         &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constraints_read</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">readConstraints</span><span class="p">()</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">readConstraints_X_ray</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">readBayesModels</span><span class="p">()</span>

        <span class="n">_lib</span><span class="o">.</span><span class="n">setBayesModel</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nvals</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_chains</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelset</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Lenstool.o_chires">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.o_chires">[docs]</a>
    <span class="k">def</span> <span class="nf">o_chires</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;chires.dat&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write a chires.dat file for the model stored in memory &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelset</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Model not set in memory. Use setBayesModel() before calling this function&quot;</span><span class="p">)</span>

        <span class="n">_lib</span><span class="o">.</span><span class="n">o_chires</span><span class="p">(</span><span class="nb">bytes</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="s2">&quot;ascii&quot;</span><span class="p">))</span></div>


<div class="viewcode-block" id="Lenstool.rescaleCube">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.rescaleCube">[docs]</a>
    <span class="k">def</span> <span class="nf">rescaleCube</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cube</span><span class="p">,</span> <span class="n">return_rescaled</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Rescale the cube values to their corresponding parameter values in</span>
<span class="sd">            Lenstool.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">              - cube[nparams]    The array containing the parameters for all the potentials. Cube values must</span>
<span class="sd">                                 follow uniform distributions in the range [0,1].</span>

<span class="sd">              - return_rescaled  If True, cube values are replaced in-place by their rescaled values.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">              - Return 1 if the rescaled parameters are meaningfull in the</span>
<span class="sd">                parameter space, 0 otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cube size mismatch (</span><span class="si">{</span><span class="mi">0</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="mi">1</span><span class="si">}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([(</span><span class="n">v</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cube</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cube value not in range [0, 1]&quot;</span><span class="p">,</span> <span class="n">cube</span><span class="p">)</span>

        <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="p">))(</span><span class="o">*</span><span class="n">cube</span><span class="p">)</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">rescaleCube_1Atom</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cube</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_modelset</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">return_rescaled</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span><span class="p">,</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">array</span><span class="p">]</span> <span class="c1"># convert ctypes.Array to list </span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">valid</span></div>


<div class="viewcode-block" id="Lenstool.write_bayes_header">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.write_bayes_header">[docs]</a>
    <span class="k">def</span> <span class="nf">write_bayes_header</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write the header of the bayes.dat file. Open the burnin.dat and bayes.dat files on the disk.</span>

<span class="sd">            Return the number of free parameters/dimensions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;bayes.dat or burnin.dat files already open. Close them first with close_bayes().&quot;</span><span class="p">)</span>

        <span class="n">nparams</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">bayesHeader</span><span class="p">()</span>
        <span class="n">_suffix</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39; &#39;</span><span class="o">*</span><span class="mi">13</span>  <span class="c1"># allocate enough memory</span>

        <span class="c1"># Need to cast here because by default ctypes converts returned c_void_p into class &lt;int&gt;</span>
        <span class="c1"># which is then truncated to 32 bits when passed to close_bayes(), and results in segfault</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">open_mcmc_files</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">_suffix</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">open_mcmc_files</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">_suffix</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
        <span class="n">_suffix</span> <span class="o">=</span> <span class="n">_suffix</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_burnin_name</span> <span class="o">=</span> <span class="s2">&quot;burnin.&quot;</span> <span class="o">+</span> <span class="n">_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bayes_name</span> <span class="o">=</span> <span class="s2">&quot;bayes.&quot;</span> <span class="o">+</span> <span class="n">_suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">userCommon_init</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nparams</span></div>


<div class="viewcode-block" id="Lenstool.write_burnin_line">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.write_burnin_line">[docs]</a>
    <span class="k">def</span> <span class="nf">write_burnin_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">likelihood</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">last_col</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write a line in the burnin.dat file with the parameter currently set in memory. </span>

<span class="sd">            Call o_chi_lhood() function is likelihood is not set.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">                - iteration: Int of the iteration number</span>
<span class="sd">                - likelihood: Likelihood of the set of parameter</span>
<span class="sd">                - coord: set of parameters</span>
<span class="sd">                - last_col: Float printed in the last column. In the case of bayeSys, current computation of the Evidence. For the nested sampling, weights of the set of parameter</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_burnin_name</span><span class="si">}</span><span class="s2"> file not open. Use write_bayes_header() function first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescaleCube</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid model with rescaled cube&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">likelihood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">lhood0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_chi_lhood0</span><span class="p">()</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span> <span class="o">+</span> <span class="n">lhood0</span><span class="p">)</span>
            
        <span class="n">_lib</span><span class="o">.</span><span class="n">write_bayes_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">likelihood</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">last_col</span><span class="p">),</span> 
                              <span class="n">iteration</span><span class="p">,</span><span class="n">iteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="Lenstool.write_bayes_line">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.write_bayes_line">[docs]</a>
    <span class="k">def</span> <span class="nf">write_bayes_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">likelihood</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write a line in the bayes.dat file with the parameter currently set in memory.</span>

<span class="sd">            Call o_chi_lhood() function is likelihood is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_bayes_name</span><span class="si">}</span><span class="s2"> file not open. Use write_bayes_header() function first.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">coord</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rescaleCube</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Invalid model with rescaled cube&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="p">)</span>
        <span class="n">chi2</span><span class="o">=</span><span class="mf">0.</span>
        <span class="k">if</span> <span class="n">likelihood</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">error</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">lhood0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_chi_lhood0</span><span class="p">()</span>
            <span class="n">likelihood</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">chi2</span> <span class="o">+</span> <span class="n">lhood0</span><span class="p">)</span>        
        <span class="n">_lib</span><span class="o">.</span><span class="n">write_bayes_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">likelihood</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">chi2</span><span class="p">),</span> 
                              <span class="n">iteration</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.write_lenstool_output">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.write_lenstool_output">[docs]</a>
    <span class="k">def</span> <span class="nf">write_lenstool_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">n_sigma</span><span class="o">=</span><span class="mf">3.</span><span class="p">,</span><span class="n">logZ</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Write best.par, bestopt.par and chires.dat from the sampling results contained in bayes.dat.</span>

<span class="sd">            Mimic the behavior of lenstool.</span>
<span class="sd">            </span>
<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">               - n_sigma: Limits of the bestopt.par are n_sigma x std</span>
<span class="sd">               - logZ: it corresponds to the marginal likelihood (i.e. Bayesian evidence) computed by bayeSys. Can be obtained with nested sampling methods.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">               - None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Read the bayes.dat, set limits and best-fit parameters</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">o_set_lens_bayes</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">n_sigma</span><span class="p">))</span>

        <span class="c1">#Needed for the header of the bestopt.par</span>
        <span class="n">error</span><span class="p">,</span> <span class="n">chi2</span><span class="p">,</span> <span class="n">lhood0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">o_chi_lhood0</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">o_chires</span><span class="p">()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">set_res_par</span><span class="p">()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">o_print_res</span><span class="p">(</span><span class="n">chi2</span><span class="p">,</span><span class="n">logZ</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Lenstool.free_optimisation_C_structure">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.free_optimisation_C_structure">[docs]</a>
    <span class="k">def</span> <span class="nf">free_optimisation_C_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run o_global_free() to free allocated structures needed for the optimisation</span>
<span class="sd">        BB: I thought it was useful but I think it only lead me to segfault</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">o_global_free</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span></div>

    
<div class="viewcode-block" id="Lenstool.close_bayes">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.close_bayes">[docs]</a>
    <span class="k">def</span> <span class="nf">close_bayes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Close the burnin.dat and bayes.dat files &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">close_mcmc_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fburnin</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fbayes</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">userCommon_free</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_userCommon</span> <span class="o">=</span> <span class="kc">None</span></div>



<div class="viewcode-block" id="Lenstool.e_lensing">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.e_lensing">[docs]</a>
    <span class="k">def</span> <span class="nf">e_lensing</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Run e_lensing() function and return the resulting array of images &quot;&quot;&quot;</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">e_lensing</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">_lib</span><span class="o">.</span><span class="n">image</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span></div>


<div class="viewcode-block" id="Lenstool.create_wcs">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.create_wcs">[docs]</a>
    <span class="k">def</span> <span class="nf">create_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span> <span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a astropy.wcs.WCS object based on boundary, size, and reference center &quot;&quot;&quot;</span>
        <span class="n">hdr</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">Header</span><span class="p">()</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;EQUINOX&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">2000.0</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CTYPE1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RA---TAN&#39;</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CRVAL1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ra</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">xmin</span><span class="o">/</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># nx-1 because if xmin=0, xmax=3, nx=4</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CDELT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3600</span>        <span class="c1"># then delta=(xmax - xmin) / (nx-1)</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CUNIT1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;deg&quot;</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CTYPE2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;DEC--TAN&#39;</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CRVAL2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dec</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ymin</span><span class="o">/</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CDELT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">3600</span>
        <span class="n">hdr</span><span class="p">[</span><span class="s1">&#39;CUNIT2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;deg&quot;</span>
        <span class="k">return</span> <span class="n">astropy</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.create_field_wcs">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.create_field_wcs">[docs]</a>
    <span class="k">def</span> <span class="nf">create_field_wcs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a astropy.wcs.WCS object based on field boundary and reference coordinates in F and M global variables &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_dec</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.e_pixel_image">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.e_pixel_image">[docs]</a>
    <span class="k">def</span> <span class="nf">e_pixel_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute and return the image of the arcs and arclets in the image plane &quot;&quot;&quot;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span>    <span class="c1"># default: assign np to nx and adjust ny</span>
        <span class="n">scale</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dy</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">scale</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span> <span class="o">+</span> <span class="n">dx</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span> <span class="o">+</span> <span class="n">dy</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">ymin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;image (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) s=</span><span class="si">%.3lf</span><span class="s2"> [</span><span class="si">%.3lf</span><span class="s2">,</span><span class="si">%.3lf</span><span class="s2">] [</span><span class="si">%.3lf</span><span class="s2">,</span><span class="si">%.3lf</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">alloc_square_double</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">null</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">o_pixel</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">scale</span><span class="p">),</span> 
            <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">xmin</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">xmax</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">ymax</span><span class="p">),</span> 
            <span class="n">_lib</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">null</span><span class="p">,</span> <span class="n">null</span>
        <span class="p">)</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">sdarray_ndarray</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">image</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_dec</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.e_pixel_source">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.e_pixel_source">[docs]</a>
    <span class="k">def</span> <span class="nf">e_pixel_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute and return the image of the arcs and arclets in the source plane &quot;&quot;&quot;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmin</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixelx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixely</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;source (</span><span class="si">%d</span><span class="s2">,</span><span class="si">%d</span><span class="s2">) s=(</span><span class="si">%.3lf</span><span class="s2">,</span><span class="si">%.3lf</span><span class="s2">) [</span><span class="si">%.3lf</span><span class="s2">,</span><span class="si">%.3lf</span><span class="s2">] [</span><span class="si">%.3lf</span><span class="s2">,</span><span class="si">%.3lf</span><span class="s2">]</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">%</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixelx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixely</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymax</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">alloc_square_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">o_pixel_source</span><span class="p">(</span>
            <span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmin</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixelx</span><span class="p">),</span> 
            <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymin</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">pixely</span><span class="p">),</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ns</span><span class="p">,</span> <span class="n">_lib</span><span class="o">.</span><span class="n">source</span>
        <span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">sdarray_ndarray</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_wcs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">nx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ny</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ps</span><span class="o">.</span><span class="n">ymax</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M</span><span class="o">.</span><span class="n">ref_dec</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.g_mass">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.g_mass">[docs]</a>
    <span class="k">def</span> <span class="nf">g_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">imass</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">zl</span><span class="p">,</span> <span class="n">zs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute density maps &quot;&quot;&quot;</span>
        <span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span>
        <span class="n">nx</span> <span class="o">=</span> <span class="n">np</span>
        <span class="n">ny</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">nx</span> <span class="o">/</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">))</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ny</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">alloc_square_double</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">computeKmap</span><span class="p">(</span>
                <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> 
                <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">dx</span><span class="p">),</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">dy</span><span class="p">),</span> 
                <span class="n">mass</span><span class="p">,</span>
                <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">zl</span><span class="p">),</span> 
                <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">zs</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">mass</span> <span class="o">=</span> <span class="n">sdarray_ndarray</span><span class="p">(</span><span class="n">mass</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">dlsds</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">dratio</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">zl</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">zs</span><span class="p">))</span>
        <span class="n">dl</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">distcosmo1</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">zl</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">imass</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
             <span class="n">mass</span> <span class="o">*=</span> <span class="n">constant</span><span class="o">.</span><span class="n">cH6piG</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">dl</span> <span class="o">/</span> <span class="n">dlsds</span>  <span class="c1"># in g/cm^2</span>
        <span class="k">if</span> <span class="n">imass</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">*=</span> <span class="n">constant</span><span class="o">.</span><span class="n">MCRIT12</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h</span> <span class="o">*</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">dl</span> <span class="o">/</span> <span class="n">dlsds</span>  <span class="c1"># in  10^12 M_sol/pixel</span>
        <span class="k">if</span> <span class="n">imass</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">mass</span> <span class="o">*=</span> <span class="n">constant</span><span class="o">.</span><span class="n">cH0_4piG</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">dl</span> <span class="o">/</span> <span class="n">dlsds</span>  <span class="c1"># in 10^12 M_sol/kpc^2</span>

        <span class="k">return</span> <span class="n">mass</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_field_wcs</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.g_ampli">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.g_ampli">[docs]</a>
    <span class="k">def</span> <span class="nf">g_ampli</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iamp</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute amplification maps &quot;&quot;&quot;</span>
        <span class="n">ampli</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">alloc_square_double</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">g_ampli_implane</span><span class="p">(</span><span class="n">iamp</span><span class="p">,</span> <span class="n">ampli</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="n">ampli</span> <span class="o">=</span> <span class="n">sdarray_ndarray</span><span class="p">(</span><span class="n">ampli</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ampli</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_field_wcs</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.get_sources">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.get_sources">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a astropy.table.Table object containing a copy of the source catalog &quot;&quot;&quot;</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ns</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span>
                <span class="n">source</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">source</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">source</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                <span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">theta</span><span class="p">),</span>
                <span class="n">source</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                <span class="n">source</span><span class="o">.</span><span class="n">mag</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="n">tab</span></div>


<div class="viewcode-block" id="Lenstool.set_sources">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.set_sources">[docs]</a>
    <span class="k">def</span> <span class="nf">set_sources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tab</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialise a set of sources based on a astropy.table.Table object &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tab</span><span class="p">):</span>
            <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="c1"># prevent from creating source object at every value assignment</span>
            <span class="n">source</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="s2">&quot;ascii&quot;</span><span class="p">)</span>
            <span class="n">source</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span>
            <span class="n">source</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;z&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">mag</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;mag&#39;</span><span class="p">]</span>
            <span class="n">source</span><span class="o">.</span><span class="n">dl0s</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">distcosmo2</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
            <span class="n">source</span><span class="o">.</span><span class="n">dos</span> <span class="o">=</span> <span class="n">_lib</span><span class="o">.</span><span class="n">distcosmo1</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">source</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
            <span class="n">source</span><span class="o">.</span><span class="n">dr</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">dl0s</span> <span class="o">/</span> <span class="n">source</span><span class="o">.</span><span class="n">dos</span>
            <span class="n">source</span><span class="o">.</span><span class="n">grad2</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">grad2</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">source</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">grad</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">source</span><span class="o">.</span><span class="n">np_grad</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">source</span><span class="o">.</span><span class="n">np_grad2a</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">np_grad2b</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">np_grad2c</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">source</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">source</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;s&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">source</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;g&#39;</span>
            <span class="n">source</span><span class="o">.</span><span class="n">I0</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tab</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.get_images">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.get_images">[docs]</a>
    <span class="k">def</span> <span class="nf">get_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a astropy.table.Table object containing a copy of the image catalog &quot;&quot;&quot;</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;theta&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="s1">&#39;mag&#39;</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">ns</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dimension</span><span class="o">.</span><span class="n">NIMAX</span><span class="p">):</span>
                <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">n</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">tab</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">a</span><span class="p">,</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">b</span><span class="p">,</span>
                        <span class="n">numpy</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">E</span><span class="o">.</span><span class="n">theta</span><span class="p">),</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
                        <span class="n">image</span><span class="o">.</span><span class="n">mag</span>
                    <span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">tab</span></div>


<div class="viewcode-block" id="Lenstool.get_lenses">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.get_lenses">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lenses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Return a astropy.table.Table object containing a copy of the lens array &quot;&quot;&quot;</span>
        <span class="n">tab</span> <span class="o">=</span> <span class="n">astropy</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;n&#39;</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;z&#39;</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;int&#39;</span><span class="p">,</span> <span class="s1">&#39;str&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">,</span> <span class="s1">&#39;float&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span><span class="p">):</span>
            <span class="n">lens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">tab</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">y</span><span class="p">,</span>
                <span class="n">lens</span><span class="o">.</span><span class="n">z</span>
            <span class="p">])</span>
        <span class="k">return</span> <span class="n">tab</span></div>


<div class="viewcode-block" id="Lenstool.add_lens">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.add_lens">[docs]</a>
    <span class="k">def</span> <span class="nf">add_lens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pot</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Add a new lens to the internal set of potentials. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">costheta</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pot</span><span class="o">.</span><span class="n">sintheta</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">costheta</span><span class="p">,</span> <span class="n">pot</span><span class="o">.</span><span class="n">sintheta</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">n</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="nb">bytes</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">no_lens</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;ascii&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">cosphi</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pot</span><span class="o">.</span><span class="n">sinphi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">cosphi</span><span class="p">,</span> <span class="n">pot</span><span class="o">.</span><span class="n">sinphi</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">costheta_3D</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pot</span><span class="o">.</span><span class="n">sintheta_3D</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">costheta_3D</span><span class="p">,</span> <span class="n">pot</span><span class="o">.</span><span class="n">sintheta_3D</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">gas_frac</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">:</span> <span class="n">pot</span><span class="o">.</span><span class="n">gas_frac</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">pot</span><span class="o">.</span><span class="n">_3D_conv_fac</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pot</span><span class="o">.</span><span class="n">_3D_scale_fac</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pot</span><span class="o">.</span><span class="n">_3D_conv_fac</span><span class="p">,</span> <span class="n">pot</span><span class="o">.</span><span class="n">_3D_scale_fac</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lens</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span><span class="p">]</span> <span class="o">=</span> <span class="n">pot</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nmsgrid</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nmsgrid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">npot</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nplens</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nplens</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">npot</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nmsgrid</span>  <span class="c1"># TODO: add support for potfile </span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">set_lens</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span></div>


<div class="viewcode-block" id="Lenstool.criticnew">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.criticnew">[docs]</a>
    <span class="k">def</span> <span class="nf">criticnew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute critical and caustic lines and return two arrays of `structure.biline` for the tangential and radial critic and caustic lines. These can be parsed using `lenstool.pcl.parse_cline()` function.</span>

<span class="sd">            If zs is None, self.S.zs is used.</span>
<span class="sd">            If one of xmin, xmax, ymin, ymax is None, corresponding field limit is taken from self.F</span>

<span class="sd">            Modified internal variables: CL.cz[0], CL.nplan, F.xmin, F.xmax, F.ymin, F.ymax, tangent, radial</span>

<span class="sd">            Return</span>
<span class="sd">            ------</span>
<span class="sd">            tangent, radial : arrays of `structure.biline`, each for critic and caustic lines</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">zs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CL</span><span class="o">.</span><span class="n">cz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">zs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">CL</span><span class="o">.</span><span class="n">cz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="o">.</span><span class="n">zs</span>

        <span class="n">old_f_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">xmin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">xmin</span>
        <span class="k">if</span> <span class="n">xmax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">xmax</span>
        <span class="k">if</span> <span class="n">ymin</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">ymin</span>
        <span class="k">if</span> <span class="n">ymax</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">ymax</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CL</span><span class="o">.</span><span class="n">nplan</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">_lib</span><span class="o">.</span><span class="n">criticnew</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="c1"># verbose mode 1</span>
        <span class="n">t_bilines</span> <span class="o">=</span> <span class="n">structure</span><span class="o">.</span><span class="n">biline</span> <span class="o">*</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NMAX</span>
        <span class="n">tangent</span> <span class="o">=</span> <span class="n">t_bilines</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">_lib</span><span class="p">,</span> <span class="s2">&quot;tangent&quot;</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">ntline</span><span class="p">]</span>
        <span class="n">radial</span> <span class="o">=</span> <span class="n">t_bilines</span><span class="o">.</span><span class="n">in_dll</span><span class="p">(</span><span class="n">_lib</span><span class="p">,</span> <span class="s2">&quot;radial&quot;</span><span class="p">)[:</span><span class="bp">self</span><span class="o">.</span><span class="n">nrline</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span> <span class="o">=</span> <span class="n">old_f_bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">old_f_bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span> <span class="o">=</span> <span class="n">old_f_bounds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">old_f_bounds</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">tangent</span><span class="p">,</span> <span class="n">radial</span></div>


<div class="viewcode-block" id="Lenstool.reset_grid">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.reset_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">reset_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Call this function after modifying self.F &quot;&quot;&quot;</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span></div>


<div class="viewcode-block" id="Lenstool.init_cosmoratio">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.init_cosmoratio">[docs]</a>
    <span class="k">def</span> <span class="nf">init_cosmoratio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cp0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the internal cosmological distance look-up-table </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          - cp0: list of tuples</span>
<span class="sd">            Each list element should contain a tuple (z1, z2, angular_diameter_distance(z1, z2))</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cp0</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">array</span> <span class="o">=</span> <span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">cpoint</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">cp0</span><span class="p">))()</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cp0</span><span class="p">):</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">z1</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">z2</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">d</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">cp</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h</span> <span class="o">/</span> <span class="n">constant</span><span class="o">.</span><span class="n">D0Mpc</span><span class="p">)</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">init_cosmoratio</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cp0</span><span class="p">),</span> <span class="n">array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_lib</span><span class="o">.</span><span class="n">init_cosmoratio</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.set_cosmology">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.set_cosmology">[docs]</a>
    <span class="k">def</span> <span class="nf">set_cosmology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">H0</span><span class="p">,</span> <span class="n">omegaM</span><span class="p">,</span> <span class="n">omegaX</span><span class="p">,</span> <span class="n">wX</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kcourb</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize internal cosmology variables</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">          - model</span>
<span class="sd">            Several models are implemented (see cosmoratio.c). model=1 is Lambda CDM model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">H0</span> <span class="o">=</span> <span class="n">H0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">omegaM</span> <span class="o">=</span> <span class="n">omegaM</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">omegaX</span> <span class="o">=</span> <span class="n">omegaX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">kcourb</span> <span class="o">=</span> <span class="n">kcourb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">wX</span> <span class="o">=</span> <span class="n">wX</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">wa</span> <span class="o">=</span> <span class="n">wa</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">C</span><span class="o">.</span><span class="n">H0</span> <span class="o">/</span> <span class="n">constant</span><span class="o">.</span><span class="n">h0</span></div>


<div class="viewcode-block" id="Lenstool.set_field">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.set_field">[docs]</a>
    <span class="k">def</span> <span class="nf">set_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Set the field section (internal F global variable) </span>
<span class="sd">    </span>
<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">          - field : list or scalar</span>
<span class="sd">            If a list, set the xmin, xmax, ymin, ymax value. If a scalar, set the dmax value centered on the lens</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">rmax</span> <span class="o">=</span> <span class="n">field</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="n">field</span><span class="p">,</span> <span class="n">field</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">xmax</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">field</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">ymax</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">field</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">rmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">field</span><span class="p">))</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span></div>


<div class="viewcode-block" id="Lenstool.set_grid">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.set_grid">[docs]</a>
    <span class="k">def</span> <span class="nf">set_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">polar</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dy</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Initialize the grid for searching multiple images &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;</span> <span class="n">dimension</span><span class="o">.</span><span class="n">NGGMAX</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;number </span><span class="si">{</span><span class="n">number</span><span class="si">}</span><span class="s2"> too large. Maximum value = </span><span class="si">{</span><span class="n">dimension</span><span class="o">.</span><span class="n">NGGMAX</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">ngrid</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">number</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">number</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="k">else</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">pol</span> <span class="o">=</span> <span class="n">polar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span></div>


<div class="viewcode-block" id="Lenstool.Mass_in_sphere">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.Mass_in_sphere">[docs]</a>
    <span class="k">def</span> <span class="nf">Mass_in_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute the mass inside spheres of radius r with r in kpc from numerical integration.</span>
<span class="sd">            The computation is based on the C code implemented in e_mass_tot.c. For now, only dPIE</span>
<span class="sd">            and B-spline are implemented.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">               - r:  numpy array containing the radius at which the mass is calculated</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">               - mass: numpy array with the total mass inside spheres of radius r. Mass given in M_sun </span>
<span class="sd">               - mass_gas: numpy array with the gas mass inside spheres of radius r. If there are no X-ray potential, it will be filled with zeros. Mass given in M_sun</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mass</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">mass_gas</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span><span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mass</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">p</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">mass</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">Circular_total_mass</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">mass_gas</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">Circular_total_mass</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mass</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">Circular_total_mass</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
                <span class="n">mass_gas</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">Circular_total_mass</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
             
        <span class="k">return</span> <span class="n">mass</span><span class="p">,</span><span class="n">mass_gas</span></div>


<div class="viewcode-block" id="Lenstool.Delta_sigma">
<a class="viewcode-back" href="../../lenstool.html#lenstool.lenstool.Lenstool.Delta_sigma">[docs]</a>
    <span class="k">def</span> <span class="nf">Delta_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot; Compute the Delta sigma for weak lensing measurement comparison for a radius r with r in kpc from numerical integration.</span>
<span class="sd">            The computation is based on the C code implemented in e_mass_tot.c. For now, only dPIE</span>
<span class="sd">            and B-spline are implemented for speed reasons (only the convergence is computed).</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">               - r:    numpy array containing the radius at which the mass is calculated</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">               - Delta sigma: numpy array with the total mass inside spheres of radius r. Output units 10^12 M_sun/kpc^2</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dsigma</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
            <span class="c1">#print(p)</span>
            <span class="n">circle_length</span><span class="o">=</span><span class="mi">2</span><span class="o">*</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]</span>
            <span class="n">disk_area</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">dsigma</span><span class="p">[</span><span class="n">p</span><span class="p">]</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">Mass_inside_rad</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span><span class="o">/</span><span class="n">disk_area</span><span class="o">-</span><span class="n">_lib</span><span class="o">.</span><span class="n">Mass_at_rad</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">p</span><span class="p">]))</span><span class="o">/</span><span class="n">circle_length</span>
        <span class="k">return</span> <span class="n">dsigma</span></div>


    <span class="c1">#BB: I will change the name or move these definition out of the lenstool code</span>
    <span class="c1"># It is related to my JAX code to take advantage of the GPU</span>
    <span class="k">def</span> <span class="nf">rescaleCube_send_lens_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">nb_param</span><span class="p">,</span><span class="n">X_ray</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">image</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">ret_valid</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">reg</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        
        <span class="c1"># There may be a better way to deal with the ctypes and numpy arrays</span>
        <span class="c1">#array = (ctypes.POINTER(ctypes.c_double) * cube.shape[0])(*map(numpy.ctypeslib.as_ctypes, cube))</span>
        <span class="n">array</span><span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="o">*</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            
        <span class="n">lens_array</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">as_ctypes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">nb_param</span><span class="p">))))</span>
        <span class="n">X_ray_error</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])()</span>
        <span class="n">likelihood_reg</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])()</span>

        <span class="n">dlsds</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">alloc_cubic_double</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">n_mult</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span><span class="p">)</span><span class="c1">#(ctypes.c_double * cube.shape[0]*self.I.n_mult*self.G.nlens)()</span>
        <span class="c1">#print(&quot;val_model&quot;,self.I.n_mult,self.G.nlens,self.X.n_pot)</span>
        <span class="n">kpc_per_arcsec_X_ray</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])(</span><span class="o">*</span><span class="nb">map</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">as_ctypes</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">n_pot</span><span class="p">))))</span>
        <span class="n">valid</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">rescale_cube_and_fill_lens</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">lens_array</span><span class="p">,</span><span class="n">dlsds</span><span class="p">,</span><span class="n">kpc_per_arcsec_X_ray</span><span class="p">,</span><span class="n">X_ray_error</span><span class="p">,</span><span class="n">likelihood_reg</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">X_ray</span><span class="p">)),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">image</span><span class="p">)),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">reg</span><span class="p">)))[:</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        
        <span class="n">param_scaled</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">nb_param</span><span class="p">),</span> <span class="n">lens_array</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="c1">#dlsds=numpy.array(list(map(lambda x: numpy.fromiter(x, dtype=float, count=self.I.n_mult*self.G.nlens), dlsds)),dtype=float).reshape(cube.shape[0],self.I.n_mult,self.G.nlens)</span>
        <span class="c1">#_lib_lt.free_square_double(lens_array,cube.shape[0])</span>
        <span class="n">dlsds_end</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">dlsds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span><span class="p">)]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">n_mult</span><span class="p">)]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">free_cubic_double</span><span class="p">(</span><span class="n">dlsds</span><span class="p">,</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">I</span><span class="o">.</span><span class="n">n_mult</span><span class="p">)</span>
        <span class="n">kpc_per_arcsec_X_ray</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">numpy</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="o">.</span><span class="n">n_pot</span><span class="p">),</span> <span class="n">kpc_per_arcsec_X_ray</span><span class="p">)),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">X_ray_error</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">X_ray_error</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">likelihood_reg</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihood_reg</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ret_valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_scaled</span><span class="p">,</span><span class="n">X_ray_error</span><span class="p">,</span><span class="n">dlsds_end</span><span class="p">,</span><span class="n">kpc_per_arcsec_X_ray</span><span class="p">,</span><span class="n">likelihood_reg</span><span class="p">,</span><span class="n">valid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_scaled</span><span class="p">,</span><span class="n">X_ray_error</span><span class="p">,</span><span class="n">dlsds_end</span><span class="p">,</span><span class="n">kpc_per_arcsec_X_ray</span><span class="p">,</span><span class="n">likelihood_reg</span>

    <span class="k">def</span> <span class="nf">batch_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">cube</span><span class="p">,</span><span class="n">image_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">return_valid</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="n">array</span><span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])(</span><span class="o">*</span><span class="n">cube</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">likelihood</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])()</span>
        <span class="n">valid</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">compute_likelihood_batch</span><span class="p">(</span><span class="n">array</span><span class="p">,</span><span class="n">likelihood</span><span class="p">,</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_nparams</span><span class="p">),</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">image_only</span><span class="p">)))[:</span><span class="n">cube</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="k">if</span> <span class="n">return_valid</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">),</span><span class="n">valid</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">likelihood</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_lens_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nb_param</span><span class="p">):</span>
        <span class="c1">#array = (ctypes.c_double * len(cube))(*cube)</span>
        <span class="n">lens_array</span><span class="o">=</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">nb_param</span><span class="p">)()</span>
        <span class="n">_lib</span><span class="o">.</span><span class="n">expose_lens_structure</span><span class="p">(</span><span class="n">lens_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lens_array</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">initialize_lens_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nb_param</span><span class="o">=</span><span class="n">_lib</span><span class="o">.</span><span class="n">expose_lens_structure_param_num</span><span class="p">()</span>
        <span class="n">nb_pot</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">G</span><span class="o">.</span><span class="n">nlens</span>
        <span class="n">pot_type</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">expose_lens_structure_type</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">nb_param</span><span class="p">))[:</span><span class="n">nb_pot</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">pot_index</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">_lib</span><span class="o">.</span><span class="n">expose_lens_structure_index</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">nb_param</span><span class="p">))[:</span><span class="n">nb_pot</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pot_type</span><span class="p">,</span><span class="n">pot_index</span><span class="p">,</span><span class="n">nb_param</span></div>


        

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Lenstool group.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>